<!-- The Plate Mapper module -->
<!-- Plate map -->

{% extends logged_in_index.html %}
{% block head %}
{% from json import dumps %}
{% autoescape None %}
<script type="text/javascript" src="/static/js/labmin.js"></script>
<script type="text/javascript" src="/static/vendor/js/jquery.validate.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
  p {
    font-weight: bold;
  }
  button {
    padding: 5px 10px 5px 10px;
    text-decoration: none;
    font-size: 80%;
  }
  #plate_map {
    width: 100%;
    table-layout: fixed;
    border: 1px solid black;
    border-collapse: collapse;
  }
  #plate_map td {
    text-align: center;
    vertical-align: middle;
    border: 1px solid black;
    margin: 0;
    padding: 0;
    background-color: rgba(255,247,188,0.75);
  }
  #plate_map td.head {
    font-size: 80%;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  input.cell {
    display: block;
    text-align: center;
    padding: 0;
    margin: 0;
    border: 0;
    width: 100%;
    border-radius: 0;
    line-height: 2.5;
  }
  input.cell:focus {
    outline: none;
    box-shadow: inset 0 0 5px rgb(44,127,184);
    background-color: white;
  }
  input[type="text"] {
    border-radius: 0;
  }
  .chosen-container-single .chosen-single {
    height: 25px;
    border-radius: 0;
    background-image: none;
    border: 1px solid black;
    margin-bottom: 1px;
    font-weight: normal;
    font-size: 90%;
  }
  .chosen-container-single .chosen-results {
    font-weight: normal;
    font-size: 90%;
  }
  .chosen-choices {
      border: 1px solid #ccc;
      border-radius: 4px;
      min-height: 34px;
      padding: 6px 12px;
  }
</style>
<script type="text/javascript">

  // Retrieve data
  var target = {{dumps(target)}};                 // Target object: sample, primer, barseq, etc.
  var id = {{dumps(id)}};                         // Plate ID (0 for creating new plate)
  var info = {{dumps(info)}};                     // Plate info: name, email, created_on, notes
  var type = {{dumps(type)}};                     // Plate type: name, cols, rows, notes
  var layout = {{dumps(layout)}};                 // Plate layout: sample_id, col, row, name, notes
  var currentuser = {{dumps(currentuser)}};       // Current user

  // Pre-process data
  // The coordinate of a well is represented by a scalar "col_row" to facilitate searching
  var well2id = {};
  for (var i = 0; i < layout.length; i++) {
    well2id[layout[i]['col'].toString() + "_" + layout[i]['row'].toString()] = i;
  }

  // Global variables
  var editing = false;                            // User is editing the plate
  var lastCell = "";                              // Last cell edited

  $(document).ready(function() {

    // Render display items
    $(".chosen-select").chosen();
    $("#plated_on").datepicker();
    $.ajax({
      url: "/pm_plate_map/ajax/",
      data: {action: "emails"},
      success: function(emails) {
        emails = JSON.parse(emails)
        for (var i = 0; i < emails.length; i++) {
          $("#plated_by").append($("<option>", {value: emails[i], text: emails[i]}));
        }
        $("#plated_by").trigger("chosen:updated");
      }
    });
    $.ajax({
      url: "/pm_plate_map/ajax/",
      data: {action: "plate_types"},
      success: function(plate_types) {
        plate_types = JSON.parse(plate_types)
        for (var i = 0; i < plate_types.length; i++) {
          $("#plate_types").append($("<option>", {value: plate_types[i], text: plate_types[i]}));
        }
        $("#plate_types").val(type["name"]);
        $("#plate_types").trigger("chosen:updated");
      }
    });

    if (id > 0) {  // View or edit an existing plate
      $("#plate_id").html("Plate # " + id.toString() + ": ");
      $("#plate_name").val(info["name"]);
      $("#plated_by").val(info["email"]);
      $("#plated_on").datepicker("setDate", info["created_on"]);
      $("#spanSave").hide();
    } else {  // Create a new plate
      $("#plated_by").val(currentuser);
      $("#plated_on").datepicker("setDate", new Date());
      $("#spanNav").hide();
      editing = true;
    }

    // Generate plate map
    var table = document.getElementById("plate_map");
    table.innerHTML = "";
    var ncol = type["cols"];
    var nrow = type["rows"];
    for (var i = 0; i <= nrow; i++) {
      var row = table.insertRow();
      var row_html = "";
      for (var j = 0; j <= ncol; j++) {
        if (i == 0) {
          if (j == 0) {
            row_html += "<td width=20></td>";
          } else {
            row_html += "<td class='head'>" + j.toString() + "</td>";
          }
        } else if (j == 0) {
          row_html += "<td class='head'>" + String.fromCharCode(64 + i); + "</td>";
        } else {
          var well = j.toString() + "_" + i.toString();
          var sample = {"sample_id": ""};
          if (well2id.hasOwnProperty(well)) {
            sample = layout[well2id[well]];
          }
          // The sample ID is stored in attributes: data-sample-original (original ID from the database) and data-sample-current (current ID after the last edit).
          row_html += ("<td><input class='cell', type='text', data-sample-original='" + sample["sample_id"] + "', data-sample-current='" + sample["sample_id"] + "'></td>");
        }
      }
      row.innerHTML = row_html;
    }

    // Hide leading zeros
    $("input.cell").each(function() {
        $(this).val($(this).attr("data-sample-current").replace(/\b0+/g, ''));
    });

    // Change a well's style when it gets focus
    $("input.cell").on("focus", function () {
      var cell = $(this).parent();
      cell.closest('tr').children('td:first').css("background-color", "darkkhaki");
      cell.closest('tr').siblings().first().children(':nth-child(' + (cell.index() + 1) + ')').css("background-color", "darkkhaki");
      $(this).val($(this).attr("data-sample-current"));
      $(this).select();
    });

    // Restore a well's style when it loses focus
    $("input.cell").on("blur", function () {
      var cell = $(this).parent();
      lastCell = cell;
      cell.closest('tr').children('td:first').css("background-color", "");
      cell.closest('tr').siblings().first().children(':nth-child(' + (cell.index() + 1) + ')').css("background-color", "");
      $(this).attr("data-sample-current", $(this).val());
      $(this).val($(this).attr("data-sample-current").replace(/\b0+/g, ''));
    });

    // Check if a cell's value has been changed, and apply style accordingly
    $("input.cell").on("input", function () {
      var valChanged = false;
      if (id == 0) {  // create new plate
        if ($(this).val()) {
            valChanged = true;
        }
      } else {  // edit existing plate
        var x = $(this).attr("data-sample-original");
        if ($(this).val() != x) {  // cell edited
          valChanged = true;
          if (x) {
            $(this).css("color", "firebrick");  // existing value changed
          } else {
            $(this).css("color", "darkgreen");  // new value added
          }
        } else {
          $(this).css("color", "black");  // value unchanged
        }
      }
      if (valChanged && !editing) {
        editing = true;
        $("#spanNav").hide();
        $("#spanSave").show();
      }
    });

    // When finishing editing a well, move focus to another well
    $("input.cell").on("keypress", function (e) {
      var cc = $(this).parent();  // current cell
      var tc = "";  // target cell
      if (e.which == 27) {  // Esc
        $(this).val($(this).attr("data-sample-current").replace(/\b0+/g, ''));
        $(this).blur();
      } else if (e.which == 9) {  // Tab
        e.preventDefault();
        if (!e.shiftKey) {  // without Shift: move right
          tc = cc.next();
        } else {  // with Shift: move left
          tc = cc.prev();
        }
      } else if (e.which == 13) {  // Enter
        $(this).blur();
        if (!e.shiftKey) {  // without Shift: move down
          if (cc.closest('tr').is(":last-child")) {
            tc = cc.closest('tr').siblings().eq(1).find('td:eq(' + (cc.index() + 1) + ')');
          } else {
            tc = cc.closest('tr').next().find('td:eq(' + cc.index() + ')');
          }
        } else if (!e.ctrlKey) {  // with Shift: move up
          if (cc.closest('tr').is(":nth-child(2)")) {
            tc = cc.closest('tr').siblings().eq(-1).find('td:eq(' + (cc.index() - 1) + ')');
          } else {
            tc = cc.closest('tr').prev().find('td:eq(' + cc.index() + ')');
          }
        } else {  // with Shift and Ctrl: fill entire column
          fillColumn(cc);
        }
      }
      if (tc.length > 0) {
        tc.children().focus();
      }
    });

  });

  function fillColumn(cc) {
    // cc: current cell
    var clear = false; strPrefix = "", strNum = "", digits = 0;
    var strInit = cc.children().attr("data-sample-current");
    if (strInit === "") {  // clear entire column
      clear = true;
    } else {  // fill entire column with incremental numbers
      var m = strInit.match(/^(.*?)(\d+)$/);
      if (m.length > 0) {  // trailing number found
        strPrefix = m[1];  // string before the number part
        strNum = m[2];  // number part
        digits = 0;
        if (strNum.charAt(0) == "0") {  // if there are leading zero(s)
          digits = strNum.length;  // record number of digits
        }
      }
    }
    if (clear || strNum.length > 0) {
      var fc = "";  // first cell to fill
      if (cc.closest('tr').is(":last-child")) {  // next column in table
        if (!cc.is(":last-child")) {  // not last column in table
          fc = cc.closest('tr').siblings().eq(1).find('td:eq(' + (cc.index() + 1) + ')');
        }
      } else {  // next cell in column
        fc = cc.closest('tr').next().find('td:eq(' + cc.index() + ')');
      }
      var curNum = 0;
      if (strNum.length > 0) {
        curNum = parseInt(strNum) + 1;
      }
      while (fc.length > 0) {  // fill till last cell in column
        fc.children().focus();
        var s = "";
        if (!clear) {  // generate current ID
          s = curNum.toString();
          while (s.length < digits) {
            s = "0" + s;
          }
          s = strPrefix + s;
          curNum += 1;
        }
        fc.children().val(s);
        fc.children().trigger("input");
        fc = fc.closest('tr').next().find('td:eq(' + fc.index() + ')');
      }
    }
  }

  // Navigate to another plate
  function navigate(move) {
    var plate_ids = JSON.parse($.ajax({
      url: "/pm_plate_map/ajax/",
      data: {action: "plate_ids"},
      global: false,
      async: false,
      success: function(result) {
        return result;
      }
    }).responseText);
    var current_index = $.inArray(parseInt(id), plate_ids);
    var target_id = null;
    var last_index = plate_ids.length - 1;
    if (move == "first") {
      target_id = plate_ids[0];
    } else if (move == "previous") {
      if (current_index > 0) {
        target_id = plate_ids[current_index - 1];
      }
    } else if (move == "next") {
      if (current_index < last_index) {
        target_id = plate_ids[current_index + 1];
      }
    } else if (move == "last") {
      target_id = plate_ids[last_index];
    } else if (move == "new") {
      target_id = 0;
    } else {
      var j = parseInt(move);
      if ($.inArray(j, plate_ids) != -1){
        if (j !== id) {
          target_id = j;
        }
      } else {
        alert("Plate ID " + move.toString() + " does not exist.");
      }
    }
    if (target_id !== null) {
      location.href = "/pm_plate_map/?target={{target}}&id=" + target_id.toString();
    }
  }

  // Show help information
  function help() {
    alert(`When finishing typing in a cell, you may press the follow keys:
           <Enter>: move down; <Shift + Enter>: move up.
           <Tab>: move right; <Shift + Tab>: move left.
           <Shift + Ctrl + Enter>: Fill the entire column with incremental numbers (if the current cell ends with number), or clear the entire column (if the current cell is empty).
           If the current cell is the last cell in a column, the column to the right will be filled / cleared.`);
  }

</script>
{% end %}

{% block content %}
<h3 id="page_title">{{target[0].upper() + target[1:]}} Plate Layout</h3>
<div style="padding-left:20px;padding-right:20px;">
  <p id="pTitle">
    <label id="plate_id">Create new plate: </label>
    <input type="text", id="plate_name", style="width:200px", data-plate-id=0>
    <label> by </label>
    <select id="plated_by" class="chosen-select" style="width:100px"></select>
    <label> on </label>
    <input type="text", id="plated_on", style="width:80px", data-plated-on="">
    &nbsp;
    <label>type: </label>
    <select id="plate_types" class="chosen-select" style="width:100px"></select>
    <span id="spanNav" style="float:right">
      <button onclick="navigate('first');">|&lt;</button>
      <button onclick="navigate('previous');">&lt;</button>
      <input type="text", value="{{id}}" style="width:35px" onkeyup="if(event.keyCode==13){navigate(this.value);}">
      <button onclick="navigate('next');">&gt;</button>
      <button onclick="navigate('last');">&gt;|</button>
      |
      <button onclick="location.href='/pm_plate_map/?target={{target}}&id=0';"><i class="fa fa-plus"></i> Create new</button>
    </span>
    <span id="spanSave" style="float:right">
      <button id="btnSave"><i class="fa fa-save"></i> Save changes</button>
    </span>
  </p>
  <p id="pTools">
    <button onclick="if(lastCell.length>0){fillColumn(lastCell);}"><i class="fa fa-columns"></i> Fill</button>
    <button onclick="help()"><i class="fa fa-question"></i> Help</button>
  </p>
  <table id="plate_map"></table>
  <hr>
</div>
{% end %}
