<!-- The Plate Mapper module -->
<!-- Plate map -->

{% extends logged_in_index.html %}
{% block head %}
{% from json import dumps %}
{% autoescape None %}
<script type="text/javascript" src="/static/js/labmin.js"></script>
<script type="text/javascript" src="/static/vendor/js/jquery.validate.min.js"></script>
<link rel="stylesheet" href="/static/vendor/font-awesome/css/font-awesome.min.css">
<style>
  p {
    font-weight: bold;
  }
  button {
    padding: 5px 10px 5px 10px;
    text-decoration: none;
    font-size: 80%;
  }
  #plate-map {
    width: 100%;
    table-layout: fixed;
    border: 1px solid black;
    border-collapse: collapse;
  }
  #plate-map td {
    text-align: center;
    vertical-align: middle;
    border: 1px solid black;
    margin: 0;
    padding: 0;
    background-color: rgba(255,247,188,0.75);
  }
  #plate-map td.head {
    font-size: 80%;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  input.cell {
    display: block;
    text-align: center;
    padding: 0;
    margin: 0;
    border: 0;
    width: 100%;
    border-radius: 0;
    line-height: 2.5;
  }
  input.cell:focus {
    outline: none;
    box-shadow: inset 0 0 5px rgb(44,127,184);
    background-color: white;
  }
  input[type="text"] {
    border-radius: 0;
  }
  .chosen-container-single .chosen-single {
    height: 25px;
    border-radius: 0;
    background-image: none;
    border: 1px solid black;
    margin-bottom: 1px;
    font-weight: normal;
    font-size: 90%;
  }
  .chosen-container-single .chosen-results {
    font-weight: normal;
    font-size: 90%;
  }
  .chosen-choices {
      border: 1px solid #ccc;
      border-radius: 4px;
      min-height: 34px;
      padding: 6px 12px;
  }
</style>
<script type="text/javascript">

  // Retrieve data
  var target = {{dumps(target)}};                 // Target object: sample, primer, barseq, etc.
  var id = {{dumps(id)}};                         // Plate ID (0 for creating new plate)
  var currentuser = {{dumps(currentuser)}};       // Current user

  // Global variables
  var info;                                       // Plate info: name, plate_type_id, email, created_on, notes
  var layout;                                     // Plate layout: sample_id, col, row, name, notes
  var editing = false;                            // User is editing the plate
  var lastCell = "";                              // Last cell edited

  $(document).ready(function() {

    /*Retrieve and display information
    */
    $(".chosen-select").chosen();
    $("#plated-on").datepicker();
    updatePlateInfo();

    // Update Email list
    function updateEmails() {
      $.get("/pm_plate_map/emails/")
        .done(function(data) {
          var emails = JSON.parse(data);
          $("#plated-by").empty();
          for (var i = 0; i < emails.length; i++) {
            $("#plated-by").append($("<option>", {value: emails[i], text: emails[i]}));
          }
          if (id > 0) {
            $("#plated-by").val(info["email"]);
          } else {
            $("#plated-by").val(currentuser);
          }
          $("#plated-by").trigger("chosen:updated");
        });
    }

    // Update plate type list
    function updatePlateTypes(type) {
      $.get("/pm_plate_map/plate_types/")
        .done(function(data) {
          var types = JSON.parse(data);
          for (var i = 0; i < types.length; i++) {
            $("#plate-types").append($("<option></option>").val(types[i]["id"]).attr({"data-cols": types[i]["cols"], "data-rows": types[i]["rows"], "data-notes": types[i]["notes"]}).text(types[i]["name"]));
          }
          if (id > 0) {
            $("#plate-types").val(info["plate_type_id"]);
          } else {
            $("#plate-types option:first-child").attr("selected", "selected");
          }
          $("#plate-types").trigger("chosen:updated");
          renderPlateMap();
        });
    }

    // Update plate information
    function updatePlateInfo() {
      if (id > 0) {  // View or edit an existing plate
        $("#plate-id").html("Plate # " + id.toString() + ": ");
        $.get("/pm_plate_map/info/", {id: id})
          .done(function(data) {
            info = JSON.parse(data);
            $("#plate-name").val(info["name"]);
            $("#plated-on").datepicker("setDate", info["created_on"]);
            $.get("/pm_plate_map/layout/", {id: id})
              .done(function(data) {
                layout = JSON.parse(data);
                updatePlateTypes();
                updateEmails();
              });
            $("#span-save").hide();
            $("#span-nav").show();
          });
      } else {  // Create a new plate
        $("#plated-on").datepicker("setDate", new Date());
        updatePlateTypes();
        updateEmails();
        $("#span-nav").hide();
        $("#span-save").show();
        editing = true;
      }
    }

    // Display plate layout
    function renderPlateMap() {
      // The coordinate of a well is represented by a scalar "col_row" to facilitate searching
      var cell2Idx = {};
      if (layout !== undefined) {
        for (var i = 0; i < layout.length; i++) {
          cell2Idx[layout[i]['col'].toString() + "_" + layout[i]['row'].toString()] = i;
        }
      }
      var table = document.getElementById("plate-map");
      table.innerHTML = "";
      var ncol = $("#plate-types").find(":selected").data("cols");
      var nrow = $("#plate-types").find(":selected").data("rows");
      for (var i = 0; i <= nrow; i++) {
        var row = table.insertRow();
        var row_html = "";
        for (var j = 0; j <= ncol; j++) {
          if (i == 0) {
            if (j == 0) {
              row_html += "<td width=20></td>";
            } else {
              row_html += "<td class='head'>" + j.toString() + "</td>";
            }
          } else if (j == 0) {
            row_html += "<td class='head'>" + String.fromCharCode(64 + i) + "</td>";
          } else {
            var cell = j.toString() + "_" + i.toString();
            var sample = {"sample_id": ""};
            if (cell2Idx.hasOwnProperty(cell)) {
              sample = layout[cell2Idx[cell]];
            }
            // The sample ID is stored in attributes: data-sample-original (original ID from the database) and data-sample-current (current ID after the last edit).
            row_html += ("<td><input class='cell', type='text', data-sample-original='" + sample["sample_id"] + "', data-sample-current='" + sample["sample_id"] + "'></td>");
          }
        }
        row.innerHTML = row_html;
      }
      // Hide leading zeros
      $("input.cell").each(function() {
          $(this).val($(this).attr("data-sample-current").replace(/\b0+/g, ''));
      });
    }

    /*Plate map events
    */
    // Change a well's style when it gets focus
    $(document).on("click", 'input.cell', function() {
      var cell = $(this).parent();
      cell.closest('tr').children('td:first').css("background-color", "darkkhaki");
      cell.closest('tr').siblings().first().children(':nth-child(' + (cell.index() + 1) + ')').css("background-color", "darkkhaki");
      $(this).val($(this).attr("data-sample-current"));
      $(this).select();
    });

    // Restore a well's style when it loses focus
    $(document).on("blur", 'input.cell', function() {
      var cell = $(this).parent();
      lastCell = cell;
      cell.closest('tr').children('td:first').css("background-color", "");
      cell.closest('tr').siblings().first().children(':nth-child(' + (cell.index() + 1) + ')').css("background-color", "");
      $(this).attr("data-sample-current", $(this).val());
      $(this).val($(this).attr("data-sample-current").replace(/\b0+/g, ''));
    });

    // Check if a cell's value has been changed, and apply style accordingly
    $(document).on("input", 'input.cell', function() {
      var valChanged = false;
      if (id == 0) {  // create new plate
        if ($(this).val()) {
            valChanged = true;
        }
      } else {  // edit existing plate
        var x = $(this).attr("data-sample-original");
        if ($(this).val() != x) {  // cell edited
          valChanged = true;
          if (x) {
            $(this).css("color", "firebrick");  // existing value changed
          } else {
            $(this).css("color", "darkgreen");  // new value added
          }
        } else {
          $(this).css("color", "black");  // value unchanged
        }
      }
      if (valChanged && !editing) {
        editing = true;
        $("#span-nav").hide();
        $("#span-save").show();
      }
    });

    // When finishing editing a well, move focus to another well
    $(document).on("keypress", 'input.cell', function(e) {
      var cc = $(this).parent();  // current cell
      var tc = "";  // target cell
      if (e.which == 27) {  // Esc
        $(this).val($(this).attr("data-sample-current").replace(/\b0+/g, ''));
        $(this).blur();
      } else if (e.which == 9) {  // Tab
        e.preventDefault();
        if (!e.shiftKey) {  // without Shift: move right
          tc = cc.next();
        } else {  // with Shift: move left
          tc = cc.prev();
        }
      } else if (e.which == 13) {  // Enter
        $(this).blur();
        if (!e.shiftKey) {  // without Shift: move down
          if (cc.closest('tr').is(":last-child")) {
            tc = cc.closest('tr').siblings().eq(1).find('td:eq(' + (cc.index() + 1) + ')');
          } else {
            tc = cc.closest('tr').next().find('td:eq(' + cc.index() + ')');
          }
        } else if (!e.ctrlKey) {  // with Shift: move up
          if (cc.closest('tr').is(":nth-child(2)")) {
            tc = cc.closest('tr').siblings().eq(-1).find('td:eq(' + (cc.index() - 1) + ')');
          } else {
            tc = cc.closest('tr').prev().find('td:eq(' + cc.index() + ')');
          }
        } else {  // with Shift and Ctrl: fill entire column
          fillColumn(cc);
        }
      }
      if (tc.length > 0) {
        tc.children().focus();
      }
    });
  });

  // Fill entire column
  function fillColumn(cc) {
    // cc: current cell
    var clear = false; strPrefix = "", strNum = "", digits = 0;
    var strInit = cc.children().attr("data-sample-current");
    if (strInit === "") {  // clear entire column
      clear = true;
    } else {  // fill entire column with incremental numbers
      var m = strInit.match(/^(.*?)(\d+)$/);
      if (m.length > 0) {  // trailing number found
        strPrefix = m[1];  // string before the number part
        strNum = m[2];  // number part
        digits = 0;
        if (strNum.charAt(0) == "0") {  // if there are leading zero(s)
          digits = strNum.length;  // record number of digits
        }
      }
    }
    if (clear || strNum.length > 0) {
      var fc = "";  // first cell to fill
      if (cc.closest('tr').is(":last-child")) {  // next column in table
        if (!cc.is(":last-child")) {  // not last column in table
          fc = cc.closest('tr').siblings().eq(1).find('td:eq(' + (cc.index() + 1) + ')');
        }
      } else {  // next cell in column
        fc = cc.closest('tr').next().find('td:eq(' + cc.index() + ')');
      }
      var curNum = 0;
      if (strNum.length > 0) {
        curNum = parseInt(strNum) + 1;
      }
      while (fc.length > 0) {  // fill till last cell in column
        fc.children().focus();
        var s = "";
        if (!clear) {  // generate current ID
          s = curNum.toString();
          while (s.length < digits) {
            s = "0" + s;
          }
          s = strPrefix + s;
          curNum += 1;
        }
        fc.children().val(s);
        fc.children().trigger("input");
        fc = fc.closest('tr').next().find('td:eq(' + fc.index() + ')');
      }
    }
  }

  // Navigate to another plate
  function navigate(move) {
    $.get("/pm_plate_map/plate_ids/")
      .done(function(data) {
        var plateIds = JSON.parse(data);
        var curIdx = $.inArray(parseInt(id), plateIds);
        var targetId = null;
        var lastIdx = plateIds.length - 1;
        if (move == "first") {
          targetId = plateIds[0];
        } else if (move == "previous") {
          if (curIdx > 0) {
            targetId = plateIds[curIdx - 1];
          }
        } else if (move == "next") {
          if (curIdx < lastIdx) {
            targetId = plateIds[curIdx + 1];
          }
        } else if (move == "last") {
          targetId = plateIds[lastIdx];
        } else if (move == "new") {
          targetId = 0;
        } else {
          var j = parseInt(move);
          if ($.inArray(j, plateIds) != -1){
            if (j !== id) {
              targetId = j;
            }
          } else {
            alert("Plate ID " + move.toString() + " does not exist.");
          }
        }
        if (targetId !== null) {
          location.href = "/pm_plate_map/?target=" + target + "&id=" + targetId.toString();
        }
      });
  }

  // Show help information
  function help() {
    alert(`When finishing typing in a cell, you may press the follow keys:
           <Enter>: move down; <Shift + Enter>: move up.
           <Tab>: move right; <Shift + Tab>: move left.
           <Shift + Ctrl + Enter>: Fill the entire column with incremental numbers (if the current cell ends with number), or clear the entire column (if the current cell is empty).
           If the current cell is the last cell in a column, the column to the right will be filled / cleared.`);
  }
</script>
{% end %}

{% block content %}
<h3 id="page-title">{{target[0].upper() + target[1:]}} Plate Layout</h3>
<div style="padding-left:20px;padding-right:20px;">
  <p id="title-bar">
    <label id="plate-id">Create new plate: </label>
    <input type="text", id="plate-name", style="width:200px", data-plate-id=0>
    <label> by </label>
    <select id="plated-by" class="chosen-select" style="width:100px"></select>
    <label> on </label>
    <input type="text", id="plated-on", style="width:80px", data-plated-on="">
    &nbsp;
    <label>type: </label>
    <select id="plate-types" class="chosen-select" style="width:100px"></select>
    <span id="span-nav" style="float:right;display:none">
      <button onclick="navigate('first');">|&lt;</button>
      <button onclick="navigate('previous');">&lt;</button>
      <input type="text", value="{{id}}" style="width:35px" onkeyup="if(event.keyCode==13){navigate(this.value);}">
      <button onclick="navigate('next');">&gt;</button>
      <button onclick="navigate('last');">&gt;|</button>
      |
      <button onclick="location.href='/pm_plate_map/?target={{target}}&id=0';"><i class="fa fa-plus"></i> Create new</button>
    </span>
    <span id="span-save" style="float:right;display:none">
      <button id="btnSave"><i class="fa fa-save"></i> Save changes</button>
    </span>
  </p>
  <p id="tool-bar">
    <button onclick="if(lastCell.length>0){fillColumn(lastCell);}"><i class="fa fa-columns"></i> Fill</button>
    <button onclick="help()"><i class="fa fa-question"></i> Help</button>
  </p>
  <table id="plate-map"></table>
  <hr>
</div>
{% end %}
